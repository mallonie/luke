<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>KuBerryPi | Luke Mallon</title><meta name=keywords content="kubernetes,raspberry pi,home lab,cluster"><meta name=description content="Setup of a Kubernetes Cluster on a set of Raspberry Pi 3 machines"><meta name=author content="Luke Mallon"><link rel=canonical href=https://luke.mallon.ie/posts/2017-02/kuberrypi/><link crossorigin=anonymous href=/assets/css/stylesheet.fedfdd25ac72a5ae00ed07c307ad04c8ff469013d540b3397e3f76c4a156bc76.css integrity="sha256-/t/dJaxypa4A7QfDB60EyP9GkBPVQLM5fj92xKFWvHY=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://luke.mallon.ie/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://luke.mallon.ie/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://luke.mallon.ie/favicon-32x32.png><link rel=apple-touch-icon href=https://luke.mallon.ie/apple-touch-icon.png><link rel=mask-icon href=https://luke.mallon.ie/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="KuBerryPi"><meta property="og:description" content="Setup of a Kubernetes Cluster on a set of Raspberry Pi 3 machines"><meta property="og:type" content="article"><meta property="og:url" content="https://luke.mallon.ie/posts/2017-02/kuberrypi/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-02-14T00:00:00+00:00"><meta property="article:modified_time" content="2017-02-14T00:00:00+00:00"><meta property="og:site_name" content="Luke Mallon"><meta name=twitter:card content="summary"><meta name=twitter:title content="KuBerryPi"><meta name=twitter:description content="Setup of a Kubernetes Cluster on a set of Raspberry Pi 3 machines"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://luke.mallon.ie/posts/"},{"@type":"ListItem","position":2,"name":"KuBerryPi","item":"https://luke.mallon.ie/posts/2017-02/kuberrypi/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"KuBerryPi","name":"KuBerryPi","description":"Setup of a Kubernetes Cluster on a set of Raspberry Pi 3 machines","keywords":["kubernetes","raspberry pi","home lab","cluster"],"articleBody":"I’m going to run through what is needed to get Kubernetes running on a cluster of Raspberry Pi 3 machines. Thankfully with the addition of kubeadm this has become fairly trivial. The getting started guide for kubeadm can give you more information about the tool itself, I’ll outline the steps here but feel free to go to that getting started guide.\nThere are a few blog posts out there that discuss doing this and suggest using hypriot (because docker didn’t officially support the arm architecture) as the OS to use. I’m going to do this with Raspbian Jessie Lite (because docker now officially supports the arm architecture) which can be downloaded here. I’m running Debian so the commands will work for the majority of Linux systems.\nYou can setup a single node or multi-node cluster of Pi. The Pi 3 is recommended because it comes with 1GB of RAM which leaves you more RAM to run your own systems on the cluster than the 512MB version.\nTo get started you’ll need to have an SD Card (I’ve used 64GB cards without issue) and load the Raspbian Jessie Lite image onto the card. You can do this using the dd command. First let’s make sure we’re using the right device on the system as we don’t want to overwrite our OS drive.\n$ df -h # This command is showing mounted volumes, you should see your sdcard listed here. Filesystem Size Used Avail Use% Mounted on /dev/sda1 8.2G 7.0G 801M 90% / udev 10M 0 10M 0% /dev tmpfs 3.2G 9.2M 3.2G 1% /run tmpfs 7.9G 507M 7.4G 7% /dev/shm tmpfs 5.0M 4.0K 5.0M 1% /run/lock tmpfs 7.9G 0 7.9G 0% /sys/fs/cgroup /dev/sda2 237M 42M 183M 19% /boot tmpfs 1.6G 56K 1.6G 1% /run/user/1000 /dev/sdb 64G 0 64G 0% /mnt/nalum/sd In this we can see that there are 3 mounted partitions for me, the drive I’m looking for is /dev/sdb. For you this could be something like /dev/mmcblk0. If you see sdb1 rather than sdb you’ll want to remove the digit or in the case of mmcblk0p1 you’ll want to remove the p1. We can double check that this is correct by running the command ls -lah /dev/mmcblk0* this will result in something like the following output:\n$ ls -lah /dev/mmcblk0* brw-rw---- 1 root disk 8, 0 Dec 15 09:43 /dev/mmcblk0 brw-rw---- 1 root disk 8, 1 Dec 15 09:43 /dev/mmcblk0p1 As you can see we have mmcblk0 and mmcblk0p1, mmcblk0 is the whole device and mmcblk0p1 is a partition on that device, there can be multiple partitions and there will be two after the Raspbian image is applied to the SDCard. We apply the Raspbian image to the SD card by using the following command:\nNOTE\nThis command will replace the contents of a drive (HDD, SSD, SDCard, etc), be absolutely certain that you are running it against the correct drive.\n$ sudo dd bs=4M if=/path/to/raspbian.image of=/dev/sdb $ sync The Raspberry Pi site notes that if bs=4M doesn’t work change it to bs=1M and that it will take longer with that setting. Running sync will make sure that it is safe to unmount the SD Card. Check here for full installation instructions for Linux, Mac OS and Windows.\nThe next step is to boot the Raspberry Pi using the SD Cards you’ve setup. You will need to plug a monitor and keyboard directly into at least one Pi as SSH has been disabled by default on the Raspbian since November 2016.\nThe following set of commands need to be run on each of the Raspbian installs. They will install any available updates, vim, docker and kubernetes and make changes to some files enabling ssh and setting a cgroup config for kubernetes/docker.\n$ sudo su $ apt-get update $ apt-get upgrade -y $ apt-get install -y vim $ vim /etc/hostname ## Replace contents with kubenode[0-9]{2,} So if you run cat /etc/hostname you should see something like the following: kubenode00\n$ touch /boot/ssh $ vim /boot/cmdline.txt ## Add `cgroup_enable=cpuset` before `elevator=deadline` If you run cat /boot/cmdline.txt you should see something like the following:\ndwc_otg.lpm_enable=0 console=serial0,115200 console=tty1 root=/dev/mmcblk0p2 rootfstype=ext4 cgroup_enable=cpuset elevator=deadline fsck.repair=yes rootwait quiet init=/usr/lib/raspi-config/init_resize.sh Now we will install docker and kubernetes and reboot:\nNOTE\nThe first curl command can be very dangerous, 1) because we ran sudo su at the beginning of this and 2) because you don’t know what is in the file you piped into sh. So I very much recommend that you download the file and have a look at what it is doing to make sure you are happy running it.\n$ curl -sSL https://get.docker.com | sh $ curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add - $ echo \"deb http://apt.kubernetes.io/ kubernetes-xenial main\" \u003e /etc/apt/sources.list.d/kubernetes.list $ apt-get update $ apt-get install -y kubelet kubeadm kubectl kubernetes-cni $ reboot now The following set of commands should be run on one Raspbian install which will setup the master Kubernetes node:\n$ sudo su $ kubeadm init --pod-network-cidr=10.244.0.0/16 --use-kubernetes-version=v1.5.2 $ curl -sSL \"https://github.com/coreos/flannel/blob/master/Documentation/kube-flannel.yml?raw=true\" | sed \"s/amd64/arm/g\" | kubectl create -f - The kubeadm init command will produce output like the following:\n[kubeadm] WARNING: kubeadm is in alpha, please do not use it for production clusters. [preflight] Running pre-flight checks [init] Using Kubernetes version: v1.5.1 [tokens] Generated token: [certificates] Generated Certificate Authority key and certificate. [certificates] Generated API Server key and certificate [certificates] Generated Service Account signing keys [certificates] Created keys and certificates in \"/etc/kubernetes/pki\" [kubeconfig] Wrote KubeConfig file to disk: \"/etc/kubernetes/kubelet.conf\" [kubeconfig] Wrote KubeConfig file to disk: \"/etc/kubernetes/admin.conf\" [apiclient] Created API client, waiting for the control plane to become ready [apiclient] All control plane components are healthy after 61.317580 seconds [apiclient] Waiting for at least one node to register and become ready [apiclient] First node is ready after 6.556101 seconds [apiclient] Creating a test deployment [apiclient] Test deployment succeeded [token-discovery] Created the kube-discovery deployment, waiting for it to become ready [token-discovery] kube-discovery is ready after 6.020980 seconds [addons] Created essential addon: kube-proxy [addons] Created essential addon: kube-dns Your Kubernetes master has initialized successfully! You should now deploy a pod network to the cluster. Run \"kubectl apply -f [podnetwork].yaml\" with one of the options listed at: http://kubernetes.io/docs/admin/addons/ You can now join any number of machines by running the following on each node: kubeadm join --token= The curl command run will setup flannel on the cluster which is required to allow the pods to talk to each other. There are other options that you can use instead of flannel if you want.\nYou need to note the kubeadm join command at the bottom of the output as you will need it for the other nodes. The last step in setup of the cluster is to add the other nodes which you can do by running the noted kubeadm join command on each of the other Raspberry Pi:\n$ sudo su $ kubeadm join --token=a123c6.d61342c6501bf2c8 192.168.168.210 With the above command run on each of the nodes you should start to see them show in the output of kubectl get nodes, you can run this on the master node and you should see something like the following:\n$ kubectl get nodes NAME STATUS AGE kubemaster Ready,master 2m kubenode01 Ready 2m kubenode02 Ready 2m To be able to control the cluster from any machine, not just the master, copy the file /etc/kubernetes/admin.conf from the master node to any other machine that you want to be able to access the cluster from. This can be combined with your existing kubectl config or you can have kubectl look at the file separate to your config by using the flag --kubeconfig.\nSo with that done you now have a Kubernetes cluster running on your Raspberry Pi. I haven’t really done anything more with my cluster since setting it up but feel free to ask questions and I’ll do my best to answer. I think the next thing I’ll be doing is setting up CephFS or NFS to act as persistent storage for the cluster.\n","wordCount":"1325","inLanguage":"en","datePublished":"2017-02-14T00:00:00Z","dateModified":"2017-02-14T00:00:00Z","author":[{"@type":"Person","name":"Luke Mallon"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://luke.mallon.ie/posts/2017-02/kuberrypi/"},"publisher":{"@type":"Organization","name":"Luke Mallon","logo":{"@type":"ImageObject","url":"https://luke.mallon.ie/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://luke.mallon.ie/ accesskey=h title="Luke Mallon (Alt + H)">Luke Mallon</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://luke.mallon.ie/about/ title=About><span>About</span></a></li><li><a href=https://luke.mallon.ie/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://luke.mallon.ie/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://luke.mallon.ie/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://luke.mallon.ie/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://luke.mallon.ie/>Home</a>&nbsp;»&nbsp;<a href=https://luke.mallon.ie/posts/>Posts</a></div><h1 class=post-title>KuBerryPi</h1><div class=post-description>Setup of a Kubernetes Cluster on a set of Raspberry Pi 3 machines</div><div class=post-meta><span title='2017-02-14 00:00:00 +0000 UTC'>2017-02-14</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;Luke Mallon</div></header><div class=post-content><p>I&rsquo;m going to run through what is needed to get Kubernetes running on a cluster
of Raspberry Pi 3 machines. Thankfully with the addition of <code>kubeadm</code> this has
become fairly trivial. The getting started guide for <a href=https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/>kubeadm</a>
can give you more information about the tool itself, I&rsquo;ll outline the steps here
but feel free to go to that getting started guide.</p><p>There are a few blog posts out there that discuss doing this and suggest using
<a href=https://blog.hypriot.com/>hypriot</a> (because docker didn&rsquo;t officially support
the arm architecture) as the OS to use. I&rsquo;m going to do this with Raspbian Jessie
Lite (because docker now officially supports the arm architecture) which can be
downloaded here. I&rsquo;m running Debian so the commands will work for the majority
of Linux systems.</p><hr><p><img loading=lazy src=/images/pi-boxes.jpeg alt="Raspberry Pi 3 Boxes" title="Raspberry Pi 3 Boxes"></p><p>You can setup a single node or multi-node cluster of Pi. The Pi 3 is recommended
because it comes with 1GB of RAM which leaves you more RAM to run your own systems
on the cluster than the 512MB version.</p><p>To get started you&rsquo;ll need to have an SD Card (I&rsquo;ve used 64GB cards without issue)
and load the Raspbian Jessie Lite image onto the card. You can do this using the
<code>dd</code> command. First let&rsquo;s make sure we&rsquo;re using the right device on the system as
we don&rsquo;t want to overwrite our OS drive.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ df -h <span style=color:#75715e># This command is showing mounted volumes, you should see your sdcard listed here.</span>
</span></span><span style=display:flex><span>Filesystem                    Size  Used Avail Use% Mounted on
</span></span><span style=display:flex><span>/dev/sda1                     8.2G  7.0G  801M  90% /
</span></span><span style=display:flex><span>udev                           10M     <span style=color:#ae81ff>0</span>   10M   0% /dev
</span></span><span style=display:flex><span>tmpfs                         3.2G  9.2M  3.2G   1% /run
</span></span><span style=display:flex><span>tmpfs                         7.9G  507M  7.4G   7% /dev/shm
</span></span><span style=display:flex><span>tmpfs                         5.0M  4.0K  5.0M   1% /run/lock
</span></span><span style=display:flex><span>tmpfs                         7.9G     <span style=color:#ae81ff>0</span>  7.9G   0% /sys/fs/cgroup
</span></span><span style=display:flex><span>/dev/sda2                     237M   42M  183M  19% /boot
</span></span><span style=display:flex><span>tmpfs                         1.6G   56K  1.6G   1% /run/user/1000
</span></span><span style=display:flex><span>/dev/sdb                       64G     <span style=color:#ae81ff>0</span>   64G   0% /mnt/nalum/sd
</span></span></code></pre></div><p>In this we can see that there are 3 mounted partitions for me, the drive I&rsquo;m
looking for is <code>/dev/sdb</code>. For you this could be something like <code>/dev/mmcblk0</code>.
If you see <code>sdb1</code> rather than sdb you&rsquo;ll want to remove the digit or in the case
of <code>mmcblk0p1</code> you&rsquo;ll want to remove the <code>p1</code>. We can double check that this is
correct by running the command <code>ls -lah /dev/mmcblk0*</code> this will result in something
like the following output:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ls -lah /dev/mmcblk0*
</span></span><span style=display:flex><span>brw-rw---- <span style=color:#ae81ff>1</span> root disk 8, <span style=color:#ae81ff>0</span> Dec <span style=color:#ae81ff>15</span> 09:43 /dev/mmcblk0
</span></span><span style=display:flex><span>brw-rw---- <span style=color:#ae81ff>1</span> root disk 8, <span style=color:#ae81ff>1</span> Dec <span style=color:#ae81ff>15</span> 09:43 /dev/mmcblk0p1
</span></span></code></pre></div><p>As you can see we have <code>mmcblk0</code> and <code>mmcblk0p1</code>, <code>mmcblk0</code> is the whole device
and <code>mmcblk0p1</code> is a partition on that device, there can be multiple partitions
and there will be two after the Raspbian image is applied to the SDCard. We apply
the Raspbian image to the SD card by using the following command:</p><blockquote><p><strong>NOTE</strong></p><p>This command will replace the contents of a drive (HDD, SSD, SDCard, etc), be
absolutely certain that you are running it against the correct drive.</p></blockquote><pre tabindex=0><code>$ sudo dd bs=4M if=/path/to/raspbian.image of=/dev/sdb
$ sync
</code></pre><p>The Raspberry Pi site notes that if <code>bs=4M</code> doesn&rsquo;t work change it to <code>bs=1M</code> and
that it will take longer with that setting. Running <code>sync</code> will make sure that
it is safe to unmount the SD Card. Check here for full installation instructions
for Linux, Mac OS and Windows.</p><p>The next step is to boot the Raspberry Pi using the SD Cards you&rsquo;ve setup. You
will need to plug a monitor and keyboard directly into at least one Pi as SSH has
been disabled by default on the Raspbian since November 2016.</p><p>The following set of commands need to be run on each of the Raspbian installs.
They will install any available updates, vim, docker and kubernetes and make
changes to some files enabling ssh and setting a cgroup config for kubernetes/docker.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo su
</span></span><span style=display:flex><span>$ apt-get update
</span></span><span style=display:flex><span>$ apt-get upgrade -y
</span></span><span style=display:flex><span>$ apt-get install -y vim
</span></span><span style=display:flex><span>$ vim /etc/hostname
</span></span><span style=display:flex><span><span style=color:#75715e>## Replace contents with kubenode[0-9]{2,}</span>
</span></span></code></pre></div><p>So if you run <code>cat /etc/hostname</code> you should see something like the following: <code>kubenode00</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ touch /boot/ssh
</span></span><span style=display:flex><span>$ vim /boot/cmdline.txt
</span></span><span style=display:flex><span><span style=color:#75715e>## Add `cgroup_enable=cpuset` before `elevator=deadline`</span>
</span></span></code></pre></div><p>If you run <code>cat /boot/cmdline.txt</code> you should see something like the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>dwc_otg.lpm_enable=0 console=serial0,115200 console=tty1 root=/dev/mmcblk0p2 rootfstype=ext4 cgroup_enable=cpuset elevator=deadline fsck.repair=yes rootwait quiet init=/usr/lib/raspi-config/init_resize.sh
</span></span></code></pre></div><p>Now we will install docker and kubernetes and reboot:</p><blockquote><p><strong>NOTE</strong></p><p>The first <code>curl</code> command can be very dangerous, 1) because we ran <code>sudo su</code> at
the beginning of this and 2) because you don&rsquo;t know what is in the file you
piped into <code>sh</code>. So I very much recommend that you download the file and have
a look at what it is doing to make sure you are happy running it.</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -sSL https://get.docker.com | sh
</span></span><span style=display:flex><span>$ curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -
</span></span><span style=display:flex><span>$ echo <span style=color:#e6db74>&#34;deb http://apt.kubernetes.io/ kubernetes-xenial main&#34;</span> &gt; /etc/apt/sources.list.d/kubernetes.list
</span></span><span style=display:flex><span>$ apt-get update
</span></span><span style=display:flex><span>$ apt-get install -y kubelet kubeadm kubectl kubernetes-cni
</span></span><span style=display:flex><span>$ reboot now
</span></span></code></pre></div><p>The following set of commands should be run on one Raspbian install which will
setup the master Kubernetes node:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo su
</span></span><span style=display:flex><span>$ kubeadm init --pod-network-cidr<span style=color:#f92672>=</span>10.244.0.0/16 --use-kubernetes-version<span style=color:#f92672>=</span>v1.5.2
</span></span><span style=display:flex><span>$ curl -sSL <span style=color:#e6db74>&#34;https://github.com/coreos/flannel/blob/master/Documentation/kube-flannel.yml?raw=true&#34;</span> | sed <span style=color:#e6db74>&#34;s/amd64/arm/g&#34;</span> | kubectl create -f -
</span></span></code></pre></div><p>The <code>kubeadm init</code> command will produce output like the following:</p><pre tabindex=0><code class=language-log data-lang=log>[kubeadm] WARNING: kubeadm is in alpha, please do not use it for production clusters.
[preflight] Running pre-flight checks
[init] Using Kubernetes version: v1.5.1
[tokens] Generated token: &lt;token&gt;
[certificates] Generated Certificate Authority key and certificate.
[certificates] Generated API Server key and certificate
[certificates] Generated Service Account signing keys
[certificates] Created keys and certificates in &#34;/etc/kubernetes/pki&#34;
[kubeconfig] Wrote KubeConfig file to disk: &#34;/etc/kubernetes/kubelet.conf&#34;
[kubeconfig] Wrote KubeConfig file to disk: &#34;/etc/kubernetes/admin.conf&#34;
[apiclient] Created API client, waiting for the control plane to become ready
[apiclient] All control plane components are healthy after 61.317580 seconds
[apiclient] Waiting for at least one node to register and become ready
[apiclient] First node is ready after 6.556101 seconds
[apiclient] Creating a test deployment
[apiclient] Test deployment succeeded
[token-discovery] Created the kube-discovery deployment, waiting for it to become ready
[token-discovery] kube-discovery is ready after 6.020980 seconds
[addons] Created essential addon: kube-proxy
[addons] Created essential addon: kube-dns

Your Kubernetes master has initialized successfully!

You should now deploy a pod network to the cluster.
Run &#34;kubectl apply -f [podnetwork].yaml&#34; with one of the options listed at:
    http://kubernetes.io/docs/admin/addons/

You can now join any number of machines by running the following on each node:

kubeadm join --token=&lt;token&gt; &lt;master-ip&gt;
</code></pre><p>The <code>curl</code> command run will setup flannel on the cluster which is required to
allow the pods to talk to each other. There are other options that you can use
instead of flannel if you want.</p><p>You need to note the <code>kubeadm join</code> command at the bottom of the output as you
will need it for the other nodes. The last step in setup of the cluster is to
add the other nodes which you can do by running the noted kubeadm join command
on each of the other Raspberry Pi:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo su
</span></span><span style=display:flex><span>$ kubeadm join --token<span style=color:#f92672>=</span>a123c6.d61342c6501bf2c8 192.168.168.210
</span></span></code></pre></div><p>With the above command run on each of the nodes you should start to see them show
in the output of <code>kubectl get nodes</code>, you can run this on the master node and you
should see something like the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get nodes
</span></span><span style=display:flex><span>NAME         STATUS         AGE
</span></span><span style=display:flex><span>kubemaster   Ready,master   2m
</span></span><span style=display:flex><span>kubenode01   Ready          2m
</span></span><span style=display:flex><span>kubenode02   Ready          2m
</span></span></code></pre></div><p>To be able to control the cluster from any machine, not just the master, copy the
file <code>/etc/kubernetes/admin.conf</code> from the master node to any other machine that
you want to be able to access the cluster from. This can be combined with your
existing <code>kubectl</code> config or you can have <code>kubectl</code> look at the file separate to
your config by using the flag <code>--kubeconfig</code>.</p><p><img loading=lazy src=/images/3-pi.jpeg alt="3 Pi" title="3 Pi"></p><p>So with that done you now have a Kubernetes cluster running on your Raspberry Pi.
I haven&rsquo;t really done anything more with my cluster since setting it up but feel
free to ask questions and I&rsquo;ll do my best to answer. I think the next thing I&rsquo;ll
be doing is setting up CephFS or NFS to act as persistent storage for the cluster.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://luke.mallon.ie/tags/kubernetes/>kubernetes</a></li><li><a href=https://luke.mallon.ie/tags/raspberry-pi/>raspberry pi</a></li><li><a href=https://luke.mallon.ie/tags/home-lab/>home lab</a></li><li><a href=https://luke.mallon.ie/tags/cluster/>cluster</a></li></ul><nav class=paginav><a class=prev href=https://luke.mallon.ie/posts/2016-10/mechanical-keyboard/><span class=title>« Prev</span><br><span>Mechanical Keyboard</span></a>
<a class=next href=https://luke.mallon.ie/posts/2022-02/flux-with-kind-and-soft-serve/><span class=title>Next »</span><br><span>Flux with Kind and Soft Serve</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share KuBerryPi on twitter" href="https://twitter.com/intent/tweet/?text=KuBerryPi&url=https%3a%2f%2fluke.mallon.ie%2fposts%2f2017-02%2fkuberrypi%2f&hashtags=kubernetes%2craspberrypi%2chomelab%2ccluster"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share KuBerryPi on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fluke.mallon.ie%2fposts%2f2017-02%2fkuberrypi%2f&title=KuBerryPi&summary=KuBerryPi&source=https%3a%2f%2fluke.mallon.ie%2fposts%2f2017-02%2fkuberrypi%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></div></footer><script src=https://utteranc.es/client.js repo=mallonie/luke issue-term=pathname label=post-comment theme=preferred-color-scheme crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2022 <a href=https://luke.mallon.ie/>Luke Mallon</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>