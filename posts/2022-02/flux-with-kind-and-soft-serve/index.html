<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Flux with Kind and Soft Serve | Luke Mallon</title><meta name=keywords content="flux,fluxcd.io,cd,continuous delivery,charm.sh,soft-serve,kubernetes,k8s,docker"><meta name=description content="Setup a local Kubernetes Cluster with Flux and SoftServe"><meta name=author content="Luke Mallon"><link rel=canonical href=https://luke.mallon.ie/posts/2022-02/flux-with-kind-and-soft-serve/><link crossorigin=anonymous href=/assets/css/stylesheet.aec5f38598c7eb6626d4c360b603795e58982d839f1701420e777c836c35734b.css integrity="sha256-rsXzhZjH62Ym1MNgtgN5XliYLYOfFwFCDnd8g2w1c0s=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://luke.mallon.ie/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://luke.mallon.ie/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://luke.mallon.ie/favicon-32x32.png><link rel=apple-touch-icon href=https://luke.mallon.ie/apple-touch-icon.png><link rel=mask-icon href=https://luke.mallon.ie/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Flux with Kind and Soft Serve"><meta property="og:description" content="Setup a local Kubernetes Cluster with Flux and SoftServe"><meta property="og:type" content="article"><meta property="og:url" content="https://luke.mallon.ie/posts/2022-02/flux-with-kind-and-soft-serve/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-02-28T00:00:00+00:00"><meta property="article:modified_time" content="2022-02-28T00:00:00+00:00"><meta property="og:site_name" content="Luke Mallon"><meta name=twitter:card content="summary"><meta name=twitter:title content="Flux with Kind and Soft Serve"><meta name=twitter:description content="Setup a local Kubernetes Cluster with Flux and SoftServe"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://luke.mallon.ie/posts/"},{"@type":"ListItem","position":2,"name":"Flux with Kind and Soft Serve","item":"https://luke.mallon.ie/posts/2022-02/flux-with-kind-and-soft-serve/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Flux with Kind and Soft Serve","name":"Flux with Kind and Soft Serve","description":"Setup a local Kubernetes Cluster with Flux and SoftServe","keywords":["flux","fluxcd.io","cd","continuous delivery","charm.sh","soft-serve","kubernetes","k8s","docker"],"articleBody":" Originally post to hackmd.io\nThis article covers getting a local Kind cluster setup with Flux and the self hosted git server Soft Serve.\nRequirements You will need to have the following installed:\ndocker installation kubectl installation kustomize installation flux installation kind installation soft installation Assumptions I am assuming the following things:\nRunning on Linux Familiar with: Docker YAML Git Kind kubectl Let‚Äôs get Started We need to run two copies of Soft Serve in order to be able to access and configure the software.\nDocker Run Soft Serve We‚Äôre going to start a local copy of Soft Serve in preparation for running a copy within the Kind cluster. Let‚Äôs assume that your Flux repository is located in /home/nalum/code/flux. You will want to setup a new environment variable: export PATH_TO_CODE=\"/home/nalum/code\". This will be used to mount your local code to both the local copy and the copy running in the Kind cluster.\nLet‚Äôs get a running instance of Soft Serve going with Docker:\n‚ùØ docker run -d \\ --name=soft-serve \\ --volume=${PATH_TO_CODE}:/soft-serve \\ --publish=23231:23231 \\ --restart=unless-stopped \\ --user=$(id -u):$(id -g) \\ --add-host=host.docker.internal:host-gateway \\ charmcli/soft-serve:latest This will start the container and then create a few directories that are used by Soft Serve as follows:\n‚ùØ cd ${PATH_TO_CODE} ‚ùØ tree -d -L 1 . ‚îú‚îÄ‚îÄ flux ‚îú‚îÄ‚îÄ repos # Created by Soft Serve ‚îî‚îÄ‚îÄ ssh # Created by Soft Serve You should also be able to ssh to the Docker Soft Serve:\n‚ùØ ssh localhost -p 23231 And you should be presented with a TUI looking something like this:\nAt this point we have the basics of what we need. You will want to clone the configuration repository from Soft Serve:\n‚ùØ git clone ssh://localhost:23231/config Cloning into 'config'... remote: Enumerating objects: 38, done. remote: Counting objects: 100% (38/38), done. remote: Compressing objects: 100% (38/38), done. remote: Total 38 (delta 11), reused 0 (delta 0), pack-reused 0 Receiving objects: 100% (38/38), 11.98 KiB | 5.99 MiB/s, done. Resolving deltas: 100% (11/11), done. You can now configure (we‚Äôll get to this later) Soft Serve to be ready for when it‚Äôs deployed on the Kind cluster. The configuration is done with YAML and the following is the starting config created by running the software:\n# The name of the server to show in the TUI. name: Soft Serve # The host and port to display in the TUI. You may want to change this if your # server is accessible from a different host and/or port that what it's # actually listening on (for example, if it's behind a reverse proxy). host: localhost port: 23231 # Access level for anonymous users. Options are: read-write, read-only and # no-access. anon-access: read-write # You can grant read-only access to users without private keys. Any password # will be accepted. allow-keyless: false # Customize repo display in the menu. Only repos in this list will appear in # the TUI. repos: - name: Home repo: config private: true note: \"Configuration and content repo for this server\" # users: # - name: Admin # admin: true # public-keys: # - KEY TEXT # - name: Example User # collab-repos: # - REPO # public-keys: # - KEY TEXT Setting Up Kind For the Kind cluster we need to mount the $PATH_TO_CODE onto one or all of the nodes running in the cluster. The following config will setup a cluster one node and the path mounted for use by containers deployed on that node:\nkind: Cluster apiVersion: kind.x-k8s.io/v1alpha4 name: dev nodes: - role: control-plane extraMounts: - hostPath: /home/nalum/code # Same value that is in $PATH_TO_CODE containerPath: /soft-serve readOnly: false selinuxRelabel: false propagation: None Get your cluster up by running the following (this will change your kubectl context):\n‚ùØ kind create cluster --config dev-config.yaml Creating cluster \"dev\" ... ‚úì Ensuring node image (kindest/node:v1.21.1) üñº ‚úì Preparing nodes üì¶ ‚úì Writing configuration üìú ‚úì Starting control-plane üïπÔ∏è ‚úì Installing CNI üîå ‚úì Installing StorageClass üíæ Set kubectl context to \"kind-dev\" You can now use your cluster with: kubectl cluster-info --context kind-dev Have a question, bug, or feature request? Let us know! https://kind.sigs.k8s.io/#community üôÇ Kind Run Soft Serve Now that we‚Äôve got the a default setup of Soft Serve and the Kind cluster running it‚Äôs time to run Soft Serve on the Kind cluster. We will define a Namespace, a Service and a Deployment to get this running on the Kind cluster.\nThe Namespace:\napiversion: v1 kind: namespace metadata: name: soft-serve labels: app: soft-serve The Service:\napiversion: v1 kind: service metadata: name: git namespace: soft-serve labels: app: soft-serve spec: type: clusterip selector: app: soft-serve ports: - name: ssh port: 23231 targetPort: 23231 protocol: TCP The Deployment:\napiVersion: apps/v1 kind: Deployment metadata: name: soft-serve namespace: soft-serve labels: app: soft-serve spec: replicas: 2 revisionHistoryLimit: 4 strategy: type: RollingUpdate rollingUpdate: maxSurge: 1 maxUnavailable: 0 selector: matchLabels: app: soft-serve template: metadata: labels: app: soft-serve spec: containers: - image: charmcli/soft-serve:latest name: soft-serve ports: - containerPort: 23231 name: ssh protocol: TCP securityContext: allowPrivilegeEscalation: false readOnlyRootFilesystem: true terminationMessagePath: /dev/termination-log terminationMessagePolicy: File volumeMounts: - mountPath: /soft-serve name: repos readOnly: true securityContext: runAsUser: 1000 runAsGroup: 1000 fsGroup: 1000 volumes: - name: repos hostPath: path: /soft-serve type: Directory In the Deployment we are setting some specific security context information to make it so the container is running as the user who owns the directory that has been mounted into the Kind node and which we are mounting into the Pod.\nWhen you install a Linux distribution and create the main user for that install it will likely have the id 1000 for the User and the Group, you can double check this by running the following commands in your terminal:\n‚ùØ id # Prints the User ID, Group ID and IDs of other groups the user is part of uid=1000(nalum) gid=1000(nalum) groups=1000(nalum),3(sys),90(network),98(power),962(realtime),964(docker),991(lp),995(audio),998(wheel) ‚ùØ id -u # Only the User ID 1000 ‚ùØ id -g # Only the Group ID (this is the main group for this user) 1000 This was used earlier when we started Soft Serve with the docker command to set the user:group for the container to run as.\nLet‚Äôs apply these resources to the Kind cluster:\n‚ùØ kubectl apply -f soft-serve.yaml namespace/soft-serve created service/git created deployment.apps/soft-serve created Now if you run the command to get the Pods in the created Namespace you should see something like the following:\n‚ùØ kubectl -n soft-serve get pods NAME READY STATUS RESTARTS AGE soft-serve-786fb9c9f8-2h4pl 1/1 Running 0 12s soft-serve-786fb9c9f8-vzxgw 1/1 Running 0 12s Configure Soft Serve Configuring Soft Serve is pretty simple, go into the config repo we cloned earlier and edit the config.yaml file (cut down file for brevity):\n... host: git.soft-serve ... repos: ... - name: Flux repo: flux private: false note: \"Flux Kind Cluster Demo running Soft Serve local git server\" ... We‚Äôve changed the host name and added a new repository to the config. To have this repository appear correctly and be used by Flux within the Kind cluster we need to create a symlink from ${PATH_TO_CODE}/flux in ${PATH_TO_CODE}/repos:\n‚ùØ cd ${PATH_TO_CODE}/repos ‚ùØ ls -lah total 12K drwxr-xr-x 3 nalum nalum 4.0K Feb 24 09:18 . drwxr-xr-x 13 nalum nalum 4.0K Feb 8 13:05 .. drwxr-xr-x 5 nalum nalum 4.0K Feb 8 13:12 config ‚ùØ ln -s ../flux ./flux ‚ùØ ls -lah total 12K drwxr-xr-x 3 nalum nalum 4.0K Feb 24 09:18 . drwxr-xr-x 13 nalum nalum 4.0K Feb 8 13:05 .. drwxr-xr-x 5 nalum nalum 4.0K Feb 8 13:12 config lrwxrwxrwx 1 nalum nalum 7 Feb 24 09:18 flux -\u003e ../flux If you have the repo setup already with a README that should display when you view it in the SSH TUI, if you don‚Äôt have a repo setup let‚Äôs do a quick setup of git and add a README file to the flux repo, something simple e.g.:\n‚ùØ cd flux ‚ùØ git init Initialized empty Git repository in /home/nalum/code/flux/.git/ ‚ùØ tee README.md \u003c","wordCount":"2325","inLanguage":"en","datePublished":"2022-02-28T00:00:00Z","dateModified":"2022-02-28T00:00:00Z","author":[{"@type":"Person","name":"Luke Mallon"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://luke.mallon.ie/posts/2022-02/flux-with-kind-and-soft-serve/"},"publisher":{"@type":"Organization","name":"Luke Mallon","logo":{"@type":"ImageObject","url":"https://luke.mallon.ie/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://luke.mallon.ie/ accesskey=h title="Luke Mallon (Alt + H)">Luke Mallon</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://luke.mallon.ie/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://luke.mallon.ie/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://luke.mallon.ie/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://luke.mallon.ie/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://luke.mallon.ie/>Home</a>&nbsp;¬ª&nbsp;<a href=https://luke.mallon.ie/posts/>Posts</a></div><h1 class=post-title>Flux with Kind and Soft Serve</h1><div class=post-description>Setup a local Kubernetes Cluster with Flux and SoftServe</div><div class=post-meta><span title='2022-02-28 00:00:00 +0000 UTC'>2022-02-28</span>&nbsp;¬∑&nbsp;11 min&nbsp;¬∑&nbsp;Luke Mallon</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#requirements aria-label=Requirements>Requirements</a><ul><li><a href=#assumptions aria-label=Assumptions>Assumptions</a></li></ul></li><li><a href=#lets-get-started aria-label="Let&amp;rsquo;s get Started">Let&rsquo;s get Started</a><ul><li><a href=#docker-run-soft-serve aria-label="Docker Run Soft Serve">Docker Run Soft Serve</a></li><li><a href=#setting-up-kind aria-label="Setting Up Kind">Setting Up Kind</a></li><li><a href=#kind-run-soft-serve aria-label="Kind Run Soft Serve">Kind Run Soft Serve</a></li><li><a href=#configure-soft-serve aria-label="Configure Soft Serve">Configure Soft Serve</a></li><li><a href=#setting-up-flux aria-label="Setting up Flux">Setting up Flux</a></li></ul></li><li><a href=#final-thoughts aria-label="Final Thoughts">Final Thoughts</a></li></ul></div></details></div><div class=post-content><blockquote><p>Originally post to <a href=https://hackmd.io/@nalum/flux-with-kind-and-soft-serve>hackmd.io</a></p></blockquote><p>This article covers getting a local <a href=https://kind.sigs.k8s.io title="Kind Website">Kind</a> cluster
setup with <a href=https://fluxcd.io title="Flux Website">Flux</a> and the self hosted git server
<a href=https://github.com/charmbracelet/soft-serve title="Soft Serve GitHub">Soft Serve</a>.</p><h2 id=requirements>Requirements<a hidden class=anchor aria-hidden=true href=#requirements>#</a></h2><p>You will need to have the following installed:</p><ul><li><code>docker</code> <a href=https://docs.docker.com/get-docker/>installation</a></li><li><code>kubectl</code> <a href=https://kubernetes.io/docs/tasks/tools/#kubectl>installation</a></li><li><code>kustomize</code> <a href=https://kubectl.docs.kubernetes.io/installation/kustomize/>installation</a></li><li><code>flux</code> <a href=https://fluxcd.io/docs/installation/ title="Install Flux">installation</a></li><li><code>kind</code> <a href=https://kind.sigs.k8s.io/#installation-and-usage title="Install Kind">installation</a></li><li><code>soft</code> <a href=https://github.com/charmbracelet/soft-serve#installation title="Install Soft Serve">installation</a></li></ul><h3 id=assumptions>Assumptions<a hidden class=anchor aria-hidden=true href=#assumptions>#</a></h3><p>I am assuming the following things:</p><ul><li>Running on Linux</li><li>Familiar with:<ul><li>Docker</li><li>YAML</li><li>Git</li><li>Kind</li><li>kubectl</li></ul></li></ul><h2 id=lets-get-started>Let&rsquo;s get Started<a hidden class=anchor aria-hidden=true href=#lets-get-started>#</a></h2><p>We need to run two copies of Soft Serve in order to be able to access and configure
the software.</p><h3 id=docker-run-soft-serve>Docker Run Soft Serve<a hidden class=anchor aria-hidden=true href=#docker-run-soft-serve>#</a></h3><p>We&rsquo;re going to start a local copy of Soft Serve in preparation for running a copy
within the Kind cluster. Let&rsquo;s assume that your Flux repository is located in <code>/home/nalum/code/flux</code>.
You will want to setup a new environment variable: <code>export PATH_TO_CODE="/home/nalum/code"</code>.
This will be used to mount your local code to both the local copy and the copy running
in the Kind cluster.</p><p>Let&rsquo;s get a running instance of Soft Serve going with Docker:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>‚ùØ docker run -d <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --name<span style=color:#f92672>=</span>soft-serve <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --volume<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>PATH_TO_CODE<span style=color:#e6db74>}</span>:/soft-serve <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --publish<span style=color:#f92672>=</span>23231:23231 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --restart<span style=color:#f92672>=</span>unless-stopped <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --user<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>id -u<span style=color:#66d9ef>)</span>:<span style=color:#66d9ef>$(</span>id -g<span style=color:#66d9ef>)</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --add-host<span style=color:#f92672>=</span>host.docker.internal:host-gateway <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  charmcli/soft-serve:latest
</span></span></code></pre></div><p>This will start the container and then create a few directories
that are used by Soft Serve as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>‚ùØ cd <span style=color:#e6db74>${</span>PATH_TO_CODE<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>‚ùØ tree -d -L <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>‚îú‚îÄ‚îÄ flux
</span></span><span style=display:flex><span>‚îú‚îÄ‚îÄ repos <span style=color:#75715e># Created by Soft Serve</span>
</span></span><span style=display:flex><span>‚îî‚îÄ‚îÄ ssh   <span style=color:#75715e># Created by Soft Serve</span>
</span></span></code></pre></div><p>You should also be able to ssh to the Docker Soft Serve:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>‚ùØ ssh localhost -p <span style=color:#ae81ff>23231</span>
</span></span></code></pre></div><p>And you should be presented with a TUI looking something like this:</p><p><img loading=lazy src=/images/ss-home.png alt="Soft Serve SSH TUI showing Home and brief message to clone the configuration repository" title="Soft Serve SSH TUI showing Home and brief message to clone the configuration repository"></p><p>At this point we have the basics of what we need. You will want to clone the configuration
repository from Soft Serve:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>‚ùØ git clone ssh://localhost:23231/config
</span></span><span style=display:flex><span>Cloning into <span style=color:#e6db74>&#39;config&#39;</span>...
</span></span><span style=display:flex><span>remote: Enumerating objects: 38, <span style=color:#66d9ef>done</span>.
</span></span><span style=display:flex><span>remote: Counting objects: 100% <span style=color:#f92672>(</span>38/38<span style=color:#f92672>)</span>, <span style=color:#66d9ef>done</span>.
</span></span><span style=display:flex><span>remote: Compressing objects: 100% <span style=color:#f92672>(</span>38/38<span style=color:#f92672>)</span>, <span style=color:#66d9ef>done</span>.
</span></span><span style=display:flex><span>remote: Total <span style=color:#ae81ff>38</span> <span style=color:#f92672>(</span>delta 11<span style=color:#f92672>)</span>, reused <span style=color:#ae81ff>0</span> <span style=color:#f92672>(</span>delta 0<span style=color:#f92672>)</span>, pack-reused <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>Receiving objects: 100% <span style=color:#f92672>(</span>38/38<span style=color:#f92672>)</span>, 11.98 KiB | 5.99 MiB/s, <span style=color:#66d9ef>done</span>.
</span></span><span style=display:flex><span>Resolving deltas: 100% <span style=color:#f92672>(</span>11/11<span style=color:#f92672>)</span>, <span style=color:#66d9ef>done</span>.
</span></span></code></pre></div><p>You can now configure (we&rsquo;ll get to this later) Soft Serve to be ready for when it&rsquo;s
deployed on the Kind cluster. The configuration is done with YAML and the following
is the starting config created by running the software:</p><pre tabindex=0><code class="language-yaml=" data-lang="yaml="># The name of the server to show in the TUI.
name: Soft Serve

# The host and port to display in the TUI. You may want to change this if your
# server is accessible from a different host and/or port that what it&#39;s
# actually listening on (for example, if it&#39;s behind a reverse proxy).
host: localhost
port: 23231

# Access level for anonymous users. Options are: read-write, read-only and
# no-access.
anon-access: read-write

# You can grant read-only access to users without private keys. Any password
# will be accepted.
allow-keyless: false

# Customize repo display in the menu. Only repos in this list will appear in
# the TUI.
repos:
- name: Home
  repo: config
  private: true
  note: &#34;Configuration and content repo for this server&#34;

# users:
#   - name: Admin
#     admin: true
#     public-keys:
#       - KEY TEXT
#   - name: Example User
#     collab-repos:
#       - REPO
#     public-keys:
#       - KEY TEXT
</code></pre><h3 id=setting-up-kind>Setting Up Kind<a hidden class=anchor aria-hidden=true href=#setting-up-kind>#</a></h3><p>For the Kind cluster we need to mount the <code>$PATH_TO_CODE</code> onto one or all of the
nodes running in the cluster. The following config will setup a cluster one node
and the path mounted for use by containers deployed on that node:</p><pre tabindex=0><code class="language-yaml=" data-lang="yaml=">kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
name: dev
nodes:
- role: control-plane
  extraMounts:
  - hostPath: /home/nalum/code # Same value that is in $PATH_TO_CODE
    containerPath: /soft-serve
    readOnly: false
    selinuxRelabel: false
    propagation: None
</code></pre><p>Get your cluster up by running the following (this will change your <code>kubectl</code> context):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>‚ùØ kind create cluster --config dev-config.yaml
</span></span><span style=display:flex><span>Creating cluster <span style=color:#e6db74>&#34;dev&#34;</span> ...
</span></span><span style=display:flex><span> ‚úì Ensuring node image <span style=color:#f92672>(</span>kindest/node:v1.21.1<span style=color:#f92672>)</span> üñº
</span></span><span style=display:flex><span> ‚úì Preparing nodes üì¶  
</span></span><span style=display:flex><span> ‚úì Writing configuration üìú 
</span></span><span style=display:flex><span> ‚úì Starting control-plane üïπÔ∏è 
</span></span><span style=display:flex><span> ‚úì Installing CNI üîå 
</span></span><span style=display:flex><span> ‚úì Installing StorageClass üíæ 
</span></span><span style=display:flex><span>Set kubectl context to <span style=color:#e6db74>&#34;kind-dev&#34;</span>
</span></span><span style=display:flex><span>You can now use your cluster with:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl cluster-info --context kind-dev
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Have a question, bug, or feature request? Let us know! https://kind.sigs.k8s.io/#community üôÇ
</span></span></code></pre></div><h3 id=kind-run-soft-serve>Kind Run Soft Serve<a hidden class=anchor aria-hidden=true href=#kind-run-soft-serve>#</a></h3><p>Now that we&rsquo;ve got the a default setup of Soft Serve and the Kind cluster running
it&rsquo;s time to run Soft Serve on the Kind cluster. We will define a <code>Namespace</code>,
a <code>Service</code> and a <code>Deployment</code> to get this running on the Kind cluster.</p><p>The <code>Namespace</code>:</p><pre tabindex=0><code class="language-yaml=" data-lang="yaml=">apiversion: v1
kind: namespace
metadata:
  name: soft-serve
  labels:
    app: soft-serve
</code></pre><p>The <code>Service</code>:</p><pre tabindex=0><code class="language-yaml=" data-lang="yaml=">apiversion: v1
kind: service
metadata:
  name: git
  namespace: soft-serve
  labels:
    app: soft-serve
spec:
  type: clusterip
  selector:
    app: soft-serve
  ports:
  - name: ssh
    port: 23231
    targetPort: 23231
    protocol: TCP
</code></pre><p>The <code>Deployment</code>:</p><pre tabindex=0><code class="language-yaml=" data-lang="yaml=">apiVersion: apps/v1
kind: Deployment
metadata:
  name: soft-serve
  namespace: soft-serve
  labels:
    app: soft-serve
spec:
  replicas: 2
  revisionHistoryLimit: 4
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: soft-serve
  template:
    metadata:
      labels:
        app: soft-serve
    spec:
      containers:
      - image: charmcli/soft-serve:latest
        name: soft-serve
        ports:
        - containerPort: 23231
          name: ssh
          protocol: TCP
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /soft-serve
          name: repos
          readOnly: true
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      volumes:
      - name: repos
        hostPath:
          path: /soft-serve
          type: Directory
</code></pre><p>In the <code>Deployment</code> we are setting some specific security context information to
make it so the container is running as the user who owns the directory that has been
mounted into the Kind node and which we are mounting into the <code>Pod</code>.</p><p>When you install a Linux distribution and create the main user for that install it
will likely have the id <code>1000</code> for the User and the Group, you can double check this
by running the following commands in your terminal:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>‚ùØ id <span style=color:#75715e># Prints the User ID, Group ID and IDs of other groups the user is part of</span>
</span></span><span style=display:flex><span>uid<span style=color:#f92672>=</span>1000<span style=color:#f92672>(</span>nalum<span style=color:#f92672>)</span> gid<span style=color:#f92672>=</span>1000<span style=color:#f92672>(</span>nalum<span style=color:#f92672>)</span> groups<span style=color:#f92672>=</span>1000<span style=color:#f92672>(</span>nalum<span style=color:#f92672>)</span>,3<span style=color:#f92672>(</span>sys<span style=color:#f92672>)</span>,90<span style=color:#f92672>(</span>network<span style=color:#f92672>)</span>,98<span style=color:#f92672>(</span>power<span style=color:#f92672>)</span>,962<span style=color:#f92672>(</span>realtime<span style=color:#f92672>)</span>,964<span style=color:#f92672>(</span>docker<span style=color:#f92672>)</span>,991<span style=color:#f92672>(</span>lp<span style=color:#f92672>)</span>,995<span style=color:#f92672>(</span>audio<span style=color:#f92672>)</span>,998<span style=color:#f92672>(</span>wheel<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>‚ùØ id -u <span style=color:#75715e># Only the User ID</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>‚ùØ id -g <span style=color:#75715e># Only the Group ID (this is the main group for this user)</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1000</span>
</span></span></code></pre></div><p>This was used earlier when we started Soft Serve with the <code>docker</code> command to set
the <code>user:group</code> for the container to run as.</p><p>Let&rsquo;s apply these resources to the Kind cluster:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>‚ùØ kubectl apply -f soft-serve.yaml
</span></span><span style=display:flex><span>namespace/soft-serve created
</span></span><span style=display:flex><span>service/git created
</span></span><span style=display:flex><span>deployment.apps/soft-serve created
</span></span></code></pre></div><p>Now if you run the command to get the <code>Pods</code> in the created <code>Namespace</code> you should
see something like the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>‚ùØ kubectl -n soft-serve get pods
</span></span><span style=display:flex><span>NAME                          READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>soft-serve-786fb9c9f8-2h4pl   1/1     Running   <span style=color:#ae81ff>0</span>          12s
</span></span><span style=display:flex><span>soft-serve-786fb9c9f8-vzxgw   1/1     Running   <span style=color:#ae81ff>0</span>          12s
</span></span></code></pre></div><h3 id=configure-soft-serve>Configure Soft Serve<a hidden class=anchor aria-hidden=true href=#configure-soft-serve>#</a></h3><p>Configuring Soft Serve is pretty simple, go into the config repo we cloned
earlier and edit the <code>config.yaml</code> file (cut down file for brevity):</p><pre tabindex=0><code class="language-yaml=" data-lang="yaml=">...
host: git.soft-serve
...
repos:
...
- name: Flux
  repo: flux
  private: false
  note: &#34;Flux Kind Cluster Demo running Soft Serve local git server&#34;
...
</code></pre><p>We&rsquo;ve changed the host name and added a new repository to the config.
To have this repository appear correctly and be used by Flux within the
<code>Kind</code> cluster we need to create a symlink from <code>${PATH_TO_CODE}/flux</code> in
<code>${PATH_TO_CODE}/repos</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>‚ùØ cd <span style=color:#e6db74>${</span>PATH_TO_CODE<span style=color:#e6db74>}</span>/repos
</span></span><span style=display:flex><span>‚ùØ ls -lah
</span></span><span style=display:flex><span>total 12K
</span></span><span style=display:flex><span>drwxr-xr-x  <span style=color:#ae81ff>3</span> nalum nalum 4.0K Feb <span style=color:#ae81ff>24</span> 09:18 .
</span></span><span style=display:flex><span>drwxr-xr-x <span style=color:#ae81ff>13</span> nalum nalum 4.0K Feb  <span style=color:#ae81ff>8</span> 13:05 ..
</span></span><span style=display:flex><span>drwxr-xr-x  <span style=color:#ae81ff>5</span> nalum nalum 4.0K Feb  <span style=color:#ae81ff>8</span> 13:12 config
</span></span><span style=display:flex><span>‚ùØ ln -s ../flux ./flux
</span></span><span style=display:flex><span>‚ùØ ls -lah
</span></span><span style=display:flex><span>total 12K
</span></span><span style=display:flex><span>drwxr-xr-x  <span style=color:#ae81ff>3</span> nalum nalum 4.0K Feb <span style=color:#ae81ff>24</span> 09:18 .
</span></span><span style=display:flex><span>drwxr-xr-x <span style=color:#ae81ff>13</span> nalum nalum 4.0K Feb  <span style=color:#ae81ff>8</span> 13:05 ..
</span></span><span style=display:flex><span>drwxr-xr-x  <span style=color:#ae81ff>5</span> nalum nalum 4.0K Feb  <span style=color:#ae81ff>8</span> 13:12 config
</span></span><span style=display:flex><span>lrwxrwxrwx  <span style=color:#ae81ff>1</span> nalum nalum    <span style=color:#ae81ff>7</span> Feb <span style=color:#ae81ff>24</span> 09:18 flux -&gt; ../flux
</span></span></code></pre></div><p>If you have the repo setup already with a README that should display when
you view it in the SSH TUI, if you don&rsquo;t have a repo setup let&rsquo;s do a quick
setup of git and add a README file to the flux repo, something simple e.g.:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>‚ùØ cd flux
</span></span><span style=display:flex><span>‚ùØ git init
</span></span><span style=display:flex><span>Initialized empty Git repository in /home/nalum/code/flux/.git/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>‚ùØ tee README.md <span style=color:#e6db74>&lt;&lt;EOT
</span></span></span><span style=display:flex><span><span style=color:#e6db74>heredoc&gt; # Flux Kind Cluster
</span></span></span><span style=display:flex><span><span style=color:#e6db74>heredoc&gt; 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>heredoc&gt; Flux GitRepository Source
</span></span></span><span style=display:flex><span><span style=color:#e6db74>heredoc&gt; EOT</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Flux Kind Cluster</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Flux GitRepository Source
</span></span><span style=display:flex><span>‚ùØ cat README.md
</span></span><span style=display:flex><span><span style=color:#75715e># Flux Kind Cluster</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Flux GitRepository Source
</span></span><span style=display:flex><span>‚ùØ git add README.md
</span></span><span style=display:flex><span>‚ùØ git commit -m <span style=color:#e6db74>&#34;Adding README&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>main <span style=color:#f92672>(</span>root-commit<span style=color:#f92672>)</span> b83b100<span style=color:#f92672>]</span> Adding README
</span></span><span style=display:flex><span> <span style=color:#ae81ff>1</span> file changed, <span style=color:#ae81ff>3</span> insertions<span style=color:#f92672>(</span>+<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> create mode <span style=color:#ae81ff>100644</span> README.md
</span></span></code></pre></div><p>In order to see this change in the SSH TUI you will need to restart the docker
container e.g. <code>docker restart soft-serve</code>. Now when you ssh into Soft Serve
running on your local docker install you will see something like the following:</p><p><img loading=lazy src=/images/ss-flux.png alt="SSH TUI View of the Flux Repo README we just added to the repo" title="SSH TUI View of the Flux Repo README we just added to the repo"></p><p>The same can be done with the instance running on the <code>Kind</code> Cluster. Restart the
running <code>Pods</code> e.g. <code>kubectl --context kind-dev -n soft-serve delete pods -l app=soft-serve</code>.
Once the <code>Pods</code> have been recreated you can port forward to one of the running <code>Pods</code>
e.g. <code>kubectl --context kind-dev -n soft-serve port-forward soft-serve-786fb9c9f8-25wkc 23232:23231</code>
In the above command I&rsquo;ve port forward the <code>Pods</code> port <code>23231</code> to the local port
<code>23232</code>. So now we can ssh into the TUI on the <code>Pod</code> and see the same view as above.</p><p>In the normal day to day use with Flux you do not need to stop and start the Soft
Serve instances unless you want to use the TUI and see the README file updates
as the TUI only appears to update when there is a push to the repo.</p><h3 id=setting-up-flux>Setting up Flux<a hidden class=anchor aria-hidden=true href=#setting-up-flux>#</a></h3><p>In the <code>flux</code> repo setup a structure like the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>‚ùØ tree -a -I .git
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>‚îú‚îÄ‚îÄ clusters
</span></span><span style=display:flex><span>‚îÇ  ‚îî‚îÄ‚îÄ dev
</span></span><span style=display:flex><span>‚îÇ      ‚îî‚îÄ‚îÄ flux-system
</span></span><span style=display:flex><span>‚îî‚îÄ‚îÄ README.md
</span></span></code></pre></div><p>We are going to export the Flux installation into the <code>flux-system</code> directory, you
can do this as follows: <code>flux install --export > clusters/dev/flux-system/gotk-components.yaml</code></p><p>I won&rsquo;t include the content of that file as there is a lot in it, but feel free to
browse. Next we&rsquo;ll want to create a <code>gotk-sync.yaml</code> and a <code>kustomization.yaml</code>.
Which you can do as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>‚ùØ flux create source git flux-system <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --git-implementation<span style=color:#f92672>=</span>libgit2 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --url<span style=color:#f92672>=</span>ssh://git@git.soft-serve:23231/flux.git <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --branch<span style=color:#f92672>=</span>main <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --interval<span style=color:#f92672>=</span>1m <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --export &gt; clusters/dev/flux-system/gotk-sync.yaml
</span></span><span style=display:flex><span>‚ùØ flux create kustomization flux-system <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --source<span style=color:#f92672>=</span>GitRepository/flux-system <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --path<span style=color:#f92672>=</span>./clusters/dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --prune<span style=color:#f92672>=</span>true <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --interval<span style=color:#f92672>=</span>1m <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --export &gt;&gt; clusters/dev/flux-system/gotk-sync.yaml
</span></span><span style=display:flex><span>‚ùØ cd clusters/dev/flux-system
</span></span><span style=display:flex><span>‚ùØ kustomize create --autodetect
</span></span><span style=display:flex><span>‚ùØ cd ../../..
</span></span><span style=display:flex><span>‚ùØ tree -a -I .git -I vendor
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>‚îú‚îÄ‚îÄ clusters
</span></span><span style=display:flex><span>‚îÇ   ‚îî‚îÄ‚îÄ dev
</span></span><span style=display:flex><span>‚îÇ       ‚îî‚îÄ‚îÄ flux-system
</span></span><span style=display:flex><span>‚îÇ           ‚îú‚îÄ‚îÄ gotk-components.yaml
</span></span><span style=display:flex><span>‚îÇ           ‚îú‚îÄ‚îÄ gotk-sync.yaml
</span></span><span style=display:flex><span>‚îÇ           ‚îî‚îÄ‚îÄ kustomization.yaml
</span></span><span style=display:flex><span>‚îî‚îÄ‚îÄ README.md
</span></span></code></pre></div><p>It is also worth adding the resource above that created the Soft Serve deployment
we are using and setting up the <code>kustomization.yaml</code> for that directory:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>‚ùØ tree -a -I .git
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>‚îú‚îÄ‚îÄ clusters
</span></span><span style=display:flex><span>‚îÇ   ‚îî‚îÄ‚îÄ dev
</span></span><span style=display:flex><span>‚îÇ       ‚îú‚îÄ‚îÄ flux-system
</span></span><span style=display:flex><span>‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ gotk-components.yaml
</span></span><span style=display:flex><span>‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ gotk-sync.yaml
</span></span><span style=display:flex><span>‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ kustomization.yaml
</span></span><span style=display:flex><span>‚îÇ       ‚îî‚îÄ‚îÄ soft-serve
</span></span><span style=display:flex><span>‚îÇ           ‚îú‚îÄ‚îÄ deployment.yaml
</span></span><span style=display:flex><span>‚îÇ           ‚îú‚îÄ‚îÄ kustomization.yaml
</span></span><span style=display:flex><span>‚îÇ           ‚îú‚îÄ‚îÄ namespace.yaml
</span></span><span style=display:flex><span>‚îÇ           ‚îî‚îÄ‚îÄ service.yaml
</span></span><span style=display:flex><span>‚îî‚îÄ‚îÄ README.md
</span></span></code></pre></div><p>Now let&rsquo;s apply the above <code>flux-system</code> resources to the Kind cluster:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>‚ùØ kubectl apply -f clusters/dev/flux-system/gotk-components.yaml
</span></span><span style=display:flex><span>namespace/flux-system created
</span></span><span style=display:flex><span>customresourcedefinition.apiextensions.k8s.io/alerts.notification.toolkit.fluxcd.io created
</span></span><span style=display:flex><span>customresourcedefinition.apiextensions.k8s.io/buckets.source.toolkit.fluxcd.io created
</span></span><span style=display:flex><span>customresourcedefinition.apiextensions.k8s.io/gitrepositories.source.toolkit.fluxcd.io created
</span></span><span style=display:flex><span>customresourcedefinition.apiextensions.k8s.io/helmcharts.source.toolkit.fluxcd.io created
</span></span><span style=display:flex><span>customresourcedefinition.apiextensions.k8s.io/helmreleases.helm.toolkit.fluxcd.io created
</span></span><span style=display:flex><span>customresourcedefinition.apiextensions.k8s.io/helmrepositories.source.toolkit.fluxcd.io created
</span></span><span style=display:flex><span>customresourcedefinition.apiextensions.k8s.io/kustomizations.kustomize.toolkit.fluxcd.io created
</span></span><span style=display:flex><span>customresourcedefinition.apiextensions.k8s.io/providers.notification.toolkit.fluxcd.io created
</span></span><span style=display:flex><span>customresourcedefinition.apiextensions.k8s.io/receivers.notification.toolkit.fluxcd.io created
</span></span><span style=display:flex><span>serviceaccount/helm-controller created
</span></span><span style=display:flex><span>serviceaccount/kustomize-controller created
</span></span><span style=display:flex><span>serviceaccount/notification-controller created
</span></span><span style=display:flex><span>serviceaccount/source-controller created
</span></span><span style=display:flex><span>clusterrole.rbac.authorization.k8s.io/crd-controller-flux-system created
</span></span><span style=display:flex><span>clusterrolebinding.rbac.authorization.k8s.io/cluster-reconciler-flux-system created
</span></span><span style=display:flex><span>clusterrolebinding.rbac.authorization.k8s.io/crd-controller-flux-system created
</span></span><span style=display:flex><span>service/notification-controller created
</span></span><span style=display:flex><span>service/source-controller created
</span></span><span style=display:flex><span>service/webhook-receiver created
</span></span><span style=display:flex><span>deployment.apps/helm-controller created
</span></span><span style=display:flex><span>deployment.apps/kustomize-controller created
</span></span><span style=display:flex><span>deployment.apps/notification-controller created
</span></span><span style=display:flex><span>deployment.apps/source-controller created
</span></span><span style=display:flex><span>networkpolicy.networking.k8s.io/allow-egress created
</span></span><span style=display:flex><span>networkpolicy.networking.k8s.io/allow-scraping created
</span></span><span style=display:flex><span>networkpolicy.networking.k8s.io/allow-webhooks created
</span></span></code></pre></div><p>Before we apply the sync file we need to setup a <code>known_hosts</code> file and an SSH Key
that Flux can work with in order to pull from our Soft Serve repo. Let&rsquo;s start
with the SSH Key:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>‚ùØ ssh-keygen -t ed25519 -C <span style=color:#e6db74>&#34;flux-system&#34;</span>
</span></span><span style=display:flex><span>Generating public/private ed25519 key pair.
</span></span><span style=display:flex><span>Enter file in which to save the key <span style=color:#f92672>(</span>/home/nalum/.ssh/id_ed25519<span style=color:#f92672>)</span>: /home/nalum/code/ssh/identity
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>+----<span style=color:#f92672>[</span>SHA256<span style=color:#f92672>]</span>-----+
</span></span></code></pre></div><p>To create the <code>known_hosts</code> file we need to get the public key of the Soft Serve
server we&rsquo;re running, we can do that with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>‚ùØ cat <span style=color:#e6db74>${</span>PATH_TO_CODE<span style=color:#e6db74>}</span>/ssh/soft_serve_server_ed25519.pub
</span></span><span style=display:flex><span>ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIMDYacTjeLH4ha6BDgWN3rXeh70GDYmaSVBw5UQg1FQ3 root@2dcd99be9aef
</span></span></code></pre></div><p>Copy this public key into a new <code>${PATH_TO_CODE}/ssh/known_hosts</code> file and put
the domain name in front of it something like the following:</p><pre tabindex=0><code class="language-=" data-lang="=">git.soft-serve:23231 ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIMDYacTjeLH4ha6BDgWN3rXeh70GDYmaSVBw5UQg1FQ3 root@2dcd99be9aef
</code></pre><p>Now that we have the SSH Key and the <code>known_hosts</code> file we need to create a secret
that Flux will pick up, you can use <code>-o yaml</code> to see the output:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>‚ùØ kubectl -n flux-system create secret generic <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --from-file<span style=color:#f92672>=</span>identity<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>PATH_TO_CODE<span style=color:#e6db74>}</span>/ssh/identity <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --from-file<span style=color:#f92672>=</span>identity.pub<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>PATH_TO_CODE<span style=color:#e6db74>}</span>/ssh/identity.pub <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --from-file<span style=color:#f92672>=</span>known_hosts<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>PATH_TO_CODE<span style=color:#e6db74>}</span>/ssh/known_hosts <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  flux-system
</span></span><span style=display:flex><span>secret/flux-system created
</span></span></code></pre></div><p>With that put in place we can then apply the sync file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>‚ùØ kubectl apply -f clusters/dev/flux-system/gotk-sync.yaml
</span></span><span style=display:flex><span>gitrepository.source.toolkit.fluxcd.io/flux-system created
</span></span><span style=display:flex><span>kustomization.kustomize.toolkit.fluxcd.io/flux-system created
</span></span></code></pre></div><p>If you now run <code>flux get all</code> you should see something like the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>‚ùØ flux get all
</span></span><span style=display:flex><span>NAME                            READY   MESSAGE                         REVISION        SUSPENDED 
</span></span><span style=display:flex><span>gitrepository/flux-system       True    Fetched revision: main/7e12f0c  main/7e12f0c    False    
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                            READY   MESSAGE                                                                                                 REVISION        SUSPENDED 
</span></span><span style=display:flex><span>kustomization/flux-system       False   kustomization path not found: stat /tmp/flux-system2367946620/clusters/dev: no such file or directory                   False
</span></span></code></pre></div><p>The <code>Kustomization</code> is not working here because we have not committed any of the
files to the repo yet. If you run <code>watch flux get all --all-namespaces</code> and the add
and commit the <code>clusters</code> folder and it&rsquo;s contents, you will see the <code>Kustomization</code>
reconcile itself:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>‚ùØ flux get all --all-namespaces
</span></span><span style=display:flex><span>NAMESPACE       NAME                            READY   MESSAGE                         REVISION        SUSPENDED 
</span></span><span style=display:flex><span>flux-system     gitrepository/flux-system       True    Fetched revision: main/b6e77db  main/b6e77db    False    
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAMESPACE       NAME                            READY   MESSAGE                         REVISION        SUSPENDED 
</span></span><span style=display:flex><span>flux-system     kustomization/flux-system       True    Applied revision: main/b6e77db  main/b6e77db    False
</span></span></code></pre></div><p>If you describe the kustomization object with kubectl you&rsquo;ll see the resources that
have been applied to the system through it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>‚ùØ kubectl -n flux-system describe kustomizations.kustomize.toolkit.fluxcd.io flux-system  
</span></span><span style=display:flex><span>Name:         flux-system
</span></span><span style=display:flex><span>Namespace:    flux-system
</span></span><span style=display:flex><span>Labels:       kustomize.toolkit.fluxcd.io/name<span style=color:#f92672>=</span>flux-system
</span></span><span style=display:flex><span>              kustomize.toolkit.fluxcd.io/namespace<span style=color:#f92672>=</span>flux-system
</span></span><span style=display:flex><span>Annotations:  &lt;none&gt;
</span></span><span style=display:flex><span>API Version:  kustomize.toolkit.fluxcd.io/v1beta2
</span></span><span style=display:flex><span>Kind:         Kustomization
</span></span><span style=display:flex><span>Metadata:
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>Events:
</span></span><span style=display:flex><span>  Type     Reason  Age    From                  Message
</span></span><span style=display:flex><span>  ----     ------  ----   ----                  -------
</span></span><span style=display:flex><span>  Warning  error   6m35s  kustomize-controller  kustomization path not found: stat /tmp/flux-system1699096295/clusters/dev: no such file or directory
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  Normal   info    115s   kustomize-controller  CustomResourceDefinition/alerts.notification.toolkit.fluxcd.io configured
</span></span><span style=display:flex><span>CustomResourceDefinition/buckets.source.toolkit.fluxcd.io configured
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>Namespace/flux-system configured
</span></span><span style=display:flex><span>Namespace/soft-serve configured
</span></span><span style=display:flex><span>ServiceAccount/flux-system/helm-controller configured
</span></span><span style=display:flex><span>ServiceAccount/flux-system/kustomize-controller configured
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>Deployment/flux-system/source-controller configured
</span></span><span style=display:flex><span>Deployment/soft-serve/soft-serve configured
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>  Normal  info  34s   kustomize-controller  Reconciliation finished in 680.646597ms, next run in 1m0s
</span></span></code></pre></div><h2 id=final-thoughts>Final Thoughts<a hidden class=anchor aria-hidden=true href=#final-thoughts>#</a></h2><p>This is a lot of work in order to use Flux from a local repository. This was a fun
exercise to get going and document here. It could be automated and be a single command
to setup the whole system, which <em>maybe</em> is worth it. I&rsquo;ll leave that for you to
decide.</p><p>Please leave a comment with your thoughts or if you have any issues following along
I&rsquo;d be happy to try helping out.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://luke.mallon.ie/tags/flux/>flux</a></li><li><a href=https://luke.mallon.ie/tags/fluxcd.io/>fluxcd.io</a></li><li><a href=https://luke.mallon.ie/tags/cd/>cd</a></li><li><a href=https://luke.mallon.ie/tags/continuous-delivery/>continuous delivery</a></li><li><a href=https://luke.mallon.ie/tags/charm.sh/>charm.sh</a></li><li><a href=https://luke.mallon.ie/tags/soft-serve/>soft-serve</a></li><li><a href=https://luke.mallon.ie/tags/kubernetes/>kubernetes</a></li><li><a href=https://luke.mallon.ie/tags/k8s/>k8s</a></li><li><a href=https://luke.mallon.ie/tags/docker/>docker</a></li></ul><nav class=paginav><a class=prev href=https://luke.mallon.ie/posts/2022-09/passwords/><span class=title>¬´ Prev</span><br><span>Passwords</span></a>
<a class=next href=https://luke.mallon.ie/posts/2017-02/kuberrypi/><span class=title>Next ¬ª</span><br><span>KuBerryPi</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Flux with Kind and Soft Serve on twitter" href="https://twitter.com/intent/tweet/?text=Flux%20with%20Kind%20and%20Soft%20Serve&url=https%3a%2f%2fluke.mallon.ie%2fposts%2f2022-02%2fflux-with-kind-and-soft-serve%2f&hashtags=flux%2cfluxcd.io%2ccd%2ccontinuousdelivery%2ccharm.sh%2csoft-serve%2ckubernetes%2ck8s%2cdocker"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Flux with Kind and Soft Serve on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fluke.mallon.ie%2fposts%2f2022-02%2fflux-with-kind-and-soft-serve%2f&title=Flux%20with%20Kind%20and%20Soft%20Serve&summary=Flux%20with%20Kind%20and%20Soft%20Serve&source=https%3a%2f%2fluke.mallon.ie%2fposts%2f2022-02%2fflux-with-kind-and-soft-serve%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></div></footer><script src=https://utteranc.es/client.js repo=mallonie/luke issue-term=pathname label=post-comment theme=preferred-color-scheme crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2022 <a href=https://luke.mallon.ie/>Luke Mallon</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>